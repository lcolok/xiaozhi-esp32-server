# 小智服务端部署心得

## 部署步骤总结

### 1. 环境准备
- Python 环境：使用 conda 创建 Python 3.10 环境
- 系统依赖：需要安装 `libopus0` 和 `ffmpeg`
- 建议使用 Linux 系统部署，本文基于 Linux 环境
- 支持多种依赖管理方式：
  1. 使用 uv（推荐，更快）：
     ```bash
     # 安装 uv
     pip install uv
     
     # 创建虚拟环境
     uv venv .venv
     
     # 激活虚拟环境
     source .venv/bin/activate
     
     # 安装依赖
     uv pip install -r requirements.txt
     ```
  
  2. 使用 Poetry：
     ```bash
     apt-get install python3-poetry
     poetry install
     ```
  
  3. 使用 pip：
     ```bash
     pip install -r requirements.txt
     ```

### 2. 关键配置点
1. **端口选择**
   - 避免使用常用端口（如 8000、8080 等）
   - 建议使用特殊端口（如 27182）避免端口冲突
   - 部署前先用 `lsof -i :端口号` 检查端口占用情况

2. **模型文件**
   - 模型文件存放位置：`models/SenseVoiceSmall/model.pt`
   - 下载地址：
     - 线路一：[阿里魔塔下载](https://modelscope.cn/models/iic/SenseVoiceSmall/resolve/master/model.pt)
     - 使用 wget 下载：`wget https://modelscope.cn/models/iic/SenseVoiceSmall/resolve/master/model.pt -O models/SenseVoiceSmall/model.pt`
   - 文件较大（约 893MB），建议使用稳定的网络下载
   - 可从阿里魔塔或百度网盘下载

3. **LLM 配置**
   - 支持多种 LLM 提供商：ChatGLM、Siliconflow、Dify 等
   - 每个提供商都需要配置相应的 API Key
   - 建议选择延迟低、稳定性好的服务商

### 3. 网络配置
1. **监听配置**
   - 服务监听地址设置为 `0.0.0.0` 允许外部访问
   - WebSocket 地址格式：`ws://域名:端口`
   - 确保防火墙允许对应端口的访问

2. **域名配置**
   - 如果有域名，可以配置域名解析
   - WebSocket 地址示例：`ws://xiaozhi.lcoso.cn:27182`

### 4. 目录结构
```
xiaozhi-esp32-server/
├── models/                # 模型文件目录
│   └── SenseVoiceSmall/  # 语音识别模型
├── tmp/                   # 临时文件目录
└── config.yaml           # 配置文件
```

## 常见问题处理

1. **启动错误**
   - 确认启动文件是 `app.py` 而不是 `main.py`
   - 如果提示缺少 `dotenv` 模块，运行：
     ```bash
     poetry add python-dotenv
     poetry install
     ```
   - 如果看到转义序列警告，可以忽略，不影响运行

2. **依赖安装失败**
   - 如果遇到网络问题，可以尝试切换 pip 源
   - 使用 Poetry 时如果提示 lock 文件不兼容：
     ```bash
     poetry lock  # 重新生成 lock 文件
     poetry install  # 安装依赖
     ```
   - 建议使用项目的 `pyproject.toml` 安装依赖

3. **环境变量配置**
   - 确保项目根目录下有 `.env` 文件
   - 如果没有 `.env` 文件，可以复制 `.env.example` 并修改：
     ```bash
     cp .env.example .env
     ```
   - 编辑 `.env` 文件，填入必要的配置（如 API Keys）

4. **Poetry 相关问题**
   - 如果遇到 "Warning: The current project could not be installed"，可以忽略
   - 如果需要，可以在 `pyproject.toml` 中添加 `package-mode = false`
   - Poetry 虚拟环境通常位于 `~/.cache/pypoetry/virtualenvs/`

5. **启动前检查清单**
   - 确认所有依赖已正确安装
   - 确认 `.env` 文件存在并配置正确
   - 确认模型文件已下载并放置在正确位置
   - 确认端口未被占用

1. **端口占用问题**
   ```bash
   # 检查端口占用
   lsof -i :端口号
   # 结束占用进程
   kill -9 进程ID
   ```

2. **依赖安装失败**
   - 如果遇到网络问题，可以尝试切换 pip 源
   - 建议使用项目的 `requirements.txt` 安装依赖

3. **模型下载失败**
   - 提供多个下载源（阿里魔塔/百度网盘）
   - 支持断点续传下载

## 运维建议

1. **日志管理**
   - 服务启动日志会显示 WebSocket 地址
   - 注意观察 ASR、VAD、LLM 等组件的运行状态

2. **性能优化**
   - 建议使用 SSD 存储以提高模型加载速度
   - 确保有足够的内存（建议 8GB 以上）

3. **安全建议**
   - 可以在 `config.yaml` 中配置认证 token
   - 建议使用防火墙限制端口访问
   - 敏感配置（如 API Key）建议使用环境变量或单独的配置文件

## 环境变量配置

### 1. 环境变量文件
项目支持使用 `.env` 文件来管理敏感配置信息（如 API keys）。你可以：

1. 复制 `.env.example` 创建 `.env` 文件：
   ```bash
   cp .env.example .env
   ```

2. 编辑 `.env` 文件，填入你的实际配置：
   ```
   # LLM API Keys
   SILICONFLOW_API_KEY=your_actual_key
   CHATGLM_API_KEY=your_actual_key
   # ... 其他配置
   ```

3. 如果你是开发者，也可以在 `data/.env` 中存放你的私有配置，它会覆盖根目录的 `.env` 配置。

### 2. 配置优先级
配置加载优先级从高到低：
1. `data/.env` 文件中的环境变量
2. 项目根目录 `.env` 文件中的环境变量
3. 系统环境变量
4. 配置文件中的默认值

### 3. 安全建议
- 不要将包含实际 API Key 的 `.env` 文件提交到代码仓库
- 在生产环境部署时，确保正确设置所有必需的环境变量
- 定期更新 API Key，提高安全性

## 配置文件说明

配置文件位于 `config.yaml`，关键配置项包括：
1. **服务器配置**
   ```yaml
   server:
     ip: 0.0.0.0  # 监听所有网络接口
     port: 27182  # 建议使用非常用端口
     auth:
       enabled: false  # 是否启用认证
       tokens:  # 设备认证令牌
         - token: "your-token1"
           name: "your-device-name1"
   ```

2. **音频参数配置**
   ```yaml
   audio_params:
     format: opus
     sample_rate: 24000
     channels: 1
     frame_duration: 60
   ```

3. **模块选择配置**
   ```yaml
   selected_module:
     ASR: FunASR  # 语音识别模块
     VAD: SileroVAD  # 语音活动检测
     LLM: SiliconflowLLM  # 大语言模型
     TTS: EdgeTTS  # 文字转语音
   ```

4. **VAD 配置**
   ```yaml
   VAD:
     SileroVAD:
       threshold: 0.5  # 语音检测阈值
       min_silence_duration_ms: 700  # 静音持续时间，可根据说话停顿调整
   ```

5. **LLM 配置示例**
   ```yaml
   LLM:
     SiliconflowLLM:  # 支持多种LLM提供商配置
       type: openai
       model_name: Qwen/Qwen2.5-72B-Instruct
       url: https://api.siliconflow.cn/v1
       api_key: ${SILICONFLOW_API_KEY}  # 从环境变量读取
   ```

### 环境变量配置优先级
1. `data/.env` > `.env` > 系统环境变量 > 配置文件默认值
2. 建议将含有敏感信息的配置（如 API Keys）放在环境变量文件中

### 启动命令
```bash
# 使用 Poetry
poetry run python main.py

# 或使用 pip 安装后直接运行
python main.py
```

## 性能调优建议

1. **VAD 参数调整**
   - `threshold`: 值越高，检测越严格
   - `min_silence_duration_ms`: 根据用户说话习惯调整，说话停顿较长可适当增加

2. **内存优化**
   - 建议内存 8GB 以上
   - 如果内存较小，可以考虑使用更轻量的模型

3. **网络优化**
   - 建议使用有线网络或稳定的 WiFi
   - 对于远程部署，确保带宽足够（建议 10Mbps 以上）

## 故障排查

1. **模型加载失败**
   - 检查模型文件完整性
   - 确认模型文件路径正确
   - 检查磁盘空间是否充足

2. **连接断开问题**
   - 检查 `close_connection_no_voice_time` 配置
   - 检查网络连接稳定性
   - 查看服务器日志定位问题

3. **音频识别问题**
   - 调整 VAD 参数
   - 检查音频格式是否符合要求
   - 验证采样率配置是否正确
