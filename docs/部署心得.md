# 小智服务端部署心得

## 部署步骤总结

### 1. 环境准备
- Python 环境：使用 conda 创建 Python 3.10 环境
- 系统依赖：需要安装 `libopus0` 和 `ffmpeg`
- 建议使用 Linux 系统部署，本文基于 Linux 环境

### 2. 关键配置点
1. **端口选择**
   - 避免使用常用端口（如 8000、8080 等）
   - 建议使用特殊端口（如 27182）避免端口冲突
   - 部署前先用 `lsof -i :端口号` 检查端口占用情况

2. **模型文件**
   - 模型文件存放位置：`models/SenseVoiceSmall/model.pt`
   - 可从阿里魔塔或百度网盘下载
   - 文件较大（约 893MB），建议使用稳定的网络下载

3. **LLM 配置**
   - 支持多种 LLM 提供商：ChatGLM、Siliconflow、Dify 等
   - 每个提供商都需要配置相应的 API Key
   - 建议选择延迟低、稳定性好的服务商

### 3. 网络配置
1. **监听配置**
   - 服务监听地址设置为 `0.0.0.0` 允许外部访问
   - WebSocket 地址格式：`ws://域名:端口`
   - 确保防火墙允许对应端口的访问

2. **域名配置**
   - 如果有域名，可以配置域名解析
   - WebSocket 地址示例：`ws://xiaozhi.lcoso.cn:27182`

### 4. 目录结构
```
xiaozhi-esp32-server/
├── models/                # 模型文件目录
│   └── SenseVoiceSmall/  # 语音识别模型
├── tmp/                   # 临时文件目录
└── config.yaml           # 配置文件
```

## 常见问题处理

1. **端口占用问题**
   ```bash
   # 检查端口占用
   lsof -i :端口号
   # 结束占用进程
   kill -9 进程ID
   ```

2. **依赖安装失败**
   - 如果遇到网络问题，可以尝试切换 pip 源
   - 建议使用项目的 `requirements.txt` 安装依赖

3. **模型下载失败**
   - 提供多个下载源（阿里魔塔/百度网盘）
   - 支持断点续传下载

## 运维建议

1. **日志管理**
   - 服务启动日志会显示 WebSocket 地址
   - 注意观察 ASR、VAD、LLM 等组件的运行状态

2. **性能优化**
   - 建议使用 SSD 存储以提高模型加载速度
   - 确保有足够的内存（建议 8GB 以上）

3. **安全建议**
   - 可以在 `config.yaml` 中配置认证 token
   - 建议使用防火墙限制端口访问
   - 敏感配置（如 API Key）建议使用环境变量或单独的配置文件

## 环境变量配置

### 1. 环境变量文件
项目支持使用 `.env` 文件来管理敏感配置信息（如 API keys）。你可以：

1. 复制 `.env.example` 创建 `.env` 文件：
   ```bash
   cp .env.example .env
   ```

2. 编辑 `.env` 文件，填入你的实际配置：
   ```
   # LLM API Keys
   SILICONFLOW_API_KEY=your_actual_key
   CHATGLM_API_KEY=your_actual_key
   # ... 其他配置
   ```

3. 如果你是开发者，也可以在 `data/.env` 中存放你的私有配置，它会覆盖根目录的 `.env` 配置。

### 2. 配置优先级
配置加载优先级从高到低：
1. `data/.env` 文件中的环境变量
2. 项目根目录 `.env` 文件中的环境变量
3. 系统环境变量
4. 配置文件中的默认值

### 3. 安全建议
- 不要将包含实际 API Key 的 `.env` 文件提交到代码仓库
- 在生产环境部署时，确保正确设置所有必需的环境变量
- 定期更新 API Key，提高安全性

## 配置文件说明

配置文件位于 `config.yaml`，关键配置项包括：
1. 服务器配置（端口、IP）
2. 认证配置（token）
3. 模型配置（ASR、VAD、LLM、TTS）

建议在开发环境中创建 `data/.config.yaml` 存放敏感配置，避免提交到代码仓库。
